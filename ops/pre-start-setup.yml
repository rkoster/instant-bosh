---
# Pre-start setup for instant-bosh container
# 
# This ops file adds a pre-start-script job that:
# 1. Starts SSH daemon for container access
# 2. Cleans up stale postgres lock files from previous container kills
# 3. Waits for postgres pre-start to finish, then initializes the database
#
# The postgres initialization (step 3) works by:
# - Waiting for postgres pre-start to complete (which runs initdb)
# - Starting postgres temporarily and calling create-database
# - Stopping postgres (BPM will start it properly after all pre-starts finish)
# 
# This ensures the postgres role exists before director workers start.

# Add os-conf release if not already present
- path: /releases/name=os-conf?
  release: os-conf
  type: replace
  value:
    name: os-conf
    sha1: d20772d8ce6e781ceb13cac7df5950bfa4330ba1
    url: https://bosh.io/d/github.com/cloudfoundry/os-conf-release?v=23.0.0
    version: 23.0.0

# Add pre-start-script job with SSH and postgres initialization
- path: /instance_groups/name=bosh/jobs/-
  type: replace
  value:
    name: pre-start-script
    release: os-conf
    properties:
      script: |-
        #!/bin/bash
        set -e
        
        # Fix LXD CPI throttle config - the release has a bug where Enabled is a string instead of boolean
        if [ -f /var/vcap/jobs/lxd_cpi/config/cpi.json ]; then
          echo "Fixing LXD CPI throttle config..."
          sed -i 's/"Enabled":"false"/"Enabled":false/' /var/vcap/jobs/lxd_cpi/config/cpi.json
          sed -i 's/"Enabled":"true"/"Enabled":true/' /var/vcap/jobs/lxd_cpi/config/cpi.json
          echo "LXD CPI throttle config fixed"
        fi
        
        # Fix Docker socket permissions so vcap user can access it
        echo "Fixing Docker socket permissions..."
        if [ -S /var/run/docker.sock ]; then
          # Change Docker socket group to vcap (GID 1000) so vcap user can access it
          # This avoids needing to add vcap to host groups and restart processes
          chgrp 1000 /var/run/docker.sock
          chmod g+rw /var/run/docker.sock
          echo "Changed Docker socket group to vcap (GID: 1000)"
          ls -la /var/run/docker.sock
        else
          echo "WARNING: Docker socket not found at /var/run/docker.sock"
        fi
        
        # Start sshd
        echo "Setting up SSH daemon..."
        mkdir -p /run/sshd
        if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
          ssh-keygen -A
        fi
        /usr/sbin/sshd
        echo "SSH daemon started"
        
        # Clean up postgres lock files from previous runs
        # This prevents "lock file already exists" errors if container was killed
        echo "Cleaning up stale postgres lock files..."
        rm -f /var/vcap/sys/run/postgres/*.pid 2>/dev/null || true
        rm -f /var/vcap/store/postgres-*/.s.PGSQL.* 2>/dev/null || true
        
        # Check if postgres needs initialization
        # The postgres pre-start (which runs initdb) will already have completed
        # or will complete shortly since all pre-starts run in parallel
        # We just need to wait a moment to ensure postgres pre-start is done
        echo "Waiting for postgres pre-start to complete..."
        sleep 5
        
        # Debug: Check if postgres data directory exists and is initialized
        echo "Checking postgres data directory..."
        if [ -d /var/vcap/store/postgres-15 ]; then
          echo "Postgres data directory exists"
          ls -la /var/vcap/store/postgres-15/ || true
        else
          echo "ERROR: Postgres data directory does not exist!"
          exit 1
        fi
        
        # Create log file for pg_ctl with proper permissions
        mkdir -p /var/vcap/sys/log/postgres
        touch /var/vcap/sys/log/postgres/pre-start-pg_ctl.log
        chown vcap:vcap /var/vcap/sys/log/postgres/pre-start-pg_ctl.log
        
        # Now start postgres temporarily to check if role exists
        echo "Starting postgres to check initialization status..."
        su vcap -c "/var/vcap/packages/postgres-15/bin/pg_ctl -D /var/vcap/store/postgres-15 -l /var/vcap/sys/log/postgres/pre-start-pg_ctl.log start" 2>&1 || {
          echo "ERROR: Failed to start postgres with pg_ctl"
          echo "Checking log file..."
          cat /var/vcap/sys/log/postgres/pre-start-pg_ctl.log 2>/dev/null || echo "Log file not found"
          exit 1
        }
        
        # Wait for postgres to be ready
        echo "Waiting for postgres to be ready..."
        for i in $(seq 1 120); do
          if /var/vcap/packages/postgres-15/bin/pg_isready -h 127.0.0.1 -p 5432 -U vcap -q 2>/dev/null; then
            echo "Postgres is ready"
            break
          fi
          sleep 1
        done
        
        # Check if postgres role exists
        echo "Checking if postgres role exists..."
        ROLE_EXISTS=$(/var/vcap/packages/postgres-15/bin/psql -h 127.0.0.1 -p 5432 -U vcap -d postgres -tAc "SELECT 1 FROM pg_roles WHERE rolname='postgres'" 2>/dev/null || echo "")
        
        if [ -n "$ROLE_EXISTS" ]; then
          echo "Postgres role already exists, skipping database setup"
        else
          echo "Postgres role does not exist, running create-database..."
          # Call create-database to set up the postgres role and bosh database
          if [ -f /var/vcap/jobs/postgres/bin/create-database ]; then
            /var/vcap/jobs/postgres/bin/create-database
            echo "Database and role created successfully"
          fi
        fi
        
        # Stop postgres - BPM will start it properly after all pre-starts complete
        echo "Stopping postgres..."
        su vcap -c "/var/vcap/packages/postgres-15/bin/pg_ctl -D /var/vcap/store/postgres-15 stop" 2>&1 || {
          echo "ERROR: Failed to stop postgres with pg_ctl"
          exit 1
        }
        
        # Clean up lock files again
        echo "Cleaning up postgres lock files..."
        rm -f /var/vcap/sys/run/postgres/*.pid 2>/dev/null || true
        rm -f /var/vcap/store/postgres-*/.s.PGSQL.* 2>/dev/null || true
        
        echo "Postgres pre-start setup complete"
