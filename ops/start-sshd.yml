---
# Start sshd via pre-start script for containers without systemd
# Since systemd is not running in the instant-bosh container, we need to
# manually start sshd using the pre-start-script job from os-conf-release

# Add os-conf release if not already present
- path: /releases/name=os-conf?
  release: os-conf
  type: replace
  value:
    name: os-conf
    sha1: d20772d8ce6e781ceb13cac7df5950bfa4330ba1
    url: https://bosh.io/d/github.com/cloudfoundry/os-conf-release?v=23.0.0
    version: 23.0.0

# Add pre-start-script job to start sshd
- path: /instance_groups/name=bosh/jobs/-
  type: replace
  value:
    name: pre-start-script
    release: os-conf
    properties:
      script: |-
        #!/bin/bash
        set -e
        
        # Create privilege separation directory for sshd
        mkdir -p /run/sshd
        
        # Ensure SSH host keys exist
        if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
          ssh-keygen -A
        fi
        
        # Start sshd (runs as daemon by default)
        /usr/sbin/sshd

